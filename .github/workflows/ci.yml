name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ '*' ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
    - name: Install dependencies
      run: |
        sudo apt install -y git-lfs # mesa-common-dev libvulkan1 mesa-vulkan-drivers vulkan-utils libpocl2 ocl-icd-opencl-dev
    - name: Download large files
      run: |
        git lfs install && \
        git lfs pull && \
        cd models && \
        ./download.sh
    - name: Coverage
      run: |
            export RUSTFLAGS="-Cinstrument-coverage" && \
            export LLVM_PROFILE_FILE="coverage-%p-%m.profraw" && \
            rustup component add llvm-tools-preview && \
            cargo install grcov && \
            cargo test --release --features blis && \
            cargo run --release --features blis --example mnist && \
            cargo run --release --features blis --example mobilenet && \
            cargo run --release --features blis --example vit && \
            cargo run --release --features blis --example infer -- ./models/mnist-8.onnx && \
            mkdir -p /tmp/cov/ && \
            cp -rf ./target/release/* ./altius-py/target/release/* /tmp/cov/ && \
            grcov . --binary-path /tmp/cov/ -s . -t cobertura --branch --ignore-not-existing --ignore "*cargo*" -o coverage.xml && \
            bash <(curl -s https://codecov.io/bash)
